document.addEventListener("DOMContentLoaded",function(){let a={};const c=window.location.pathname.split("/")[1];d();function d(){p(),s()}function p(){document.getElementById("apply-filters").addEventListener("click",s),document.querySelectorAll(".preset-btn").forEach(e=>{e.addEventListener("click",function(){const n=this.dataset.days;u(n),s()})}),document.getElementById("export-data").addEventListener("click",function(e){e.preventDefault(),_()})}function u(e){const n=document.getElementById("date-from"),t=document.getElementById("date-to"),o=new Date;switch(e){case"30":n.value=new Date(o.getTime()-720*60*60*1e3).toISOString().split("T")[0],t.value=o.toISOString().split("T")[0];break;case"90":n.value=new Date(o.getTime()-2160*60*60*1e3).toISOString().split("T")[0],t.value=o.toISOString().split("T")[0];break;case"ytd":n.value=new Date(o.getFullYear(),0,1).toISOString().split("T")[0],t.value=o.toISOString().split("T")[0];break;case"all":n.value="2020-01-01",t.value=o.toISOString().split("T")[0];break}}function g(){document.getElementById("loading-state").classList.remove("hidden")}function m(){document.getElementById("loading-state").classList.add("hidden")}async function s(){g();try{const e=document.getElementById("date-from").value,n=document.getElementById("date-to").value,t=await fetch(`/${c}/analytics/data?from=${e}&to=${n}`,{headers:{"X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")}});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const o=await t.json();b(o),f(o)}catch(e){console.error("Error loading analytics data:",e),alert("Error loading analytics data. Please try again.")}finally{m()}}function b(e){const n=e.applications_over_time.reduce((r,i)=>r+i.applications_count,0),t=e.hires_over_time.reduce((r,i)=>r+i.hires_count,0),o=e.pipeline_snapshot.reduce((r,i)=>r+i.in_stage_count,0);document.getElementById("kpi-total-applications").textContent=n.toLocaleString(),document.getElementById("kpi-hires").textContent=t.toLocaleString(),document.getElementById("kpi-median-time").textContent=e.time_to_hire_summary.median_days+" days",document.getElementById("kpi-active-pipeline").textContent=o.toLocaleString()}function f(e){Object.values(a).forEach(n=>{n&&n.destroy()}),a={},y(e.applications_over_time),h(e.hires_over_time),C(e.stage_funnel),v(e.source_effectiveness),E(e.open_jobs_by_dept),I(e.pipeline_snapshot)}function y(e){const n=document.getElementById("applications-chart").getContext("2d");a.applications=new Chart(n,{type:"line",data:{labels:e.map(t=>l(t.date)),datasets:[{label:"Applications",data:e.map(t=>t.applications_count),borderColor:"rgb(59, 130, 246)",backgroundColor:"rgba(59, 130, 246, 0.1)",tension:.1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0}}}})}function h(e){const n=document.getElementById("hires-chart").getContext("2d");a.hires=new Chart(n,{type:"line",data:{labels:e.map(t=>l(t.date)),datasets:[{label:"Hires",data:e.map(t=>t.hires_count),borderColor:"rgb(34, 197, 94)",backgroundColor:"rgba(34, 197, 94, 0.1)",tension:.1,fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0}}}})}function C(e){const n=document.getElementById("stage-funnel-chart").getContext("2d");a.stageFunnel=new Chart(n,{type:"bar",data:{labels:e.map(t=>t.stage),datasets:[{label:"Applications",data:e.map(t=>t.applications_count),backgroundColor:"rgba(147, 51, 234, 0.8)",borderColor:"rgb(147, 51, 234)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",scales:{x:{beginAtZero:!0}}}})}function v(e){const n=document.getElementById("source-effectiveness-container"),t=document.getElementById("source-effectiveness-chart").getContext("2d");if(e.length===1&&e[0].applications===0){n.style.display="none";return}n.style.display="block",a.sourceEffectiveness=new Chart(t,{type:"bar",data:{labels:e.map(o=>o.source),datasets:[{label:"Applications",data:e.map(o=>o.applications),backgroundColor:"rgba(59, 130, 246, 0.8)",borderColor:"rgb(59, 130, 246)",borderWidth:1},{label:"Hired",data:e.map(o=>o.hired),backgroundColor:"rgba(34, 197, 94, 0.8)",borderColor:"rgb(34, 197, 94)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0}}}})}function E(e){const n=document.getElementById("open-jobs-chart").getContext("2d");a.openJobs=new Chart(n,{type:"bar",data:{labels:e.map(t=>t.department),datasets:[{label:"Open Jobs",data:e.map(t=>t.open_jobs),backgroundColor:"rgba(245, 158, 11, 0.8)",borderColor:"rgb(245, 158, 11)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0}}}})}function I(e){const n=document.getElementById("pipeline-snapshot-chart").getContext("2d");a.pipelineSnapshot=new Chart(n,{type:"doughnut",data:{labels:e.map(t=>t.stage),datasets:[{data:e.map(t=>t.in_stage_count),backgroundColor:["rgba(59, 130, 246, 0.8)","rgba(34, 197, 94, 0.8)","rgba(245, 158, 11, 0.8)","rgba(239, 68, 68, 0.8)","rgba(147, 51, 234, 0.8)"],borderColor:["rgb(59, 130, 246)","rgb(34, 197, 94)","rgb(245, 158, 11)","rgb(239, 68, 68)","rgb(147, 51, 234)"],borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}}}})}function l(e){if(e.includes("-W")){const[n,t]=e.split("-W");return`W${t} ${n}`}return new Date(e).toLocaleDateString()}function _(){const e=document.getElementById("date-from").value,n=document.getElementById("date-to").value;window.open(`/${c}/analytics/export?from=${e}&to=${n}`,"_blank")}});
